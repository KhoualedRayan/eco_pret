{% extends 'base.html.twig' %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('styles/profil.css') }}">
<link rel="stylesheet" href="{{ asset('styles/annonces.css') }}">
<script src="{{ asset('scripts/profil.js') }}"></script>
{% endblock %}

{% block title %}Profil{% endblock %}

{% block body %}

{% for flashMessage in app.flashes('success') %}
        <div class="alert alert-success">
            {{ flashMessage }}
        </div>
    {% endfor %}

<div class="intro">
    <div>
        Bienvenue <span class="bold">{{ app.user.username }}</span> !
    </div>
    <div style="display: flex;">
        <div class="solde">Solde :&nbsp;<span class="bold">{{ app.user.nbflorains }}</span> <span class="material-icons spe">attach_money</span></div>
        Abonnement&nbsp;<span class="bold">{{ app.user.abonnement.nom }}</span>&nbsp;(fin : {{ app.user.dateAbonnement|date_modify('+1 year')|date('d/m/Y') }})
    </div>
</div>

<div class="tab-container">
    <div class="tab-buttons">
        <button class="tab-button" onclick="openTab(event, 'tab1')">Informations personnelles</button>
        <button class="tab-button" onclick="openTab(event, 'tab2')">Mes Annonces</button>
        <button class="tab-button" onclick="openTab(event, 'tab3')">Mes Transactions</button>
        <button class="tab-button" onclick="openTab(event, 'tab4')">Mon Planning</button>
    </div>

    <div id="tab1" class="tab active">
        <span class="material-icons edit" title="modifier vos informations" onclick='edit(this)'>{% if edit_mode %}cancel{% else %}edit_square{% endif %}
        </span>
        <button class="but" onclick="openDialog()" style="float: right;">Changer mon mot de passe</button>
        <h3>Vos informations personnelles</h3>
        <div>
            <form action="{{ path('handle_infos_form') }}" method="POST">
                <div style="display: flex;">
                    <div>
                        <div class="blockI">
                            <label>Nom d'utilisateur</label><br>
                            <input type="text" name="username" value="{{ app.user.username }}" {% if not edit_mode %}readonly{% endif %}><br>
                            <div class="erreur">{% if errors['username'] is defined %} {{ errors['username'] }} {% endif %}</div>
                        </div>
                        <div class="blockI">
                            <label>Email</label><br>
                            <input type="email" name="email" value="{{ app.user.email }}" {% if not edit_mode %}readonly{% endif %}><br>
                            <div class="erreur">{% if errors['email'] is defined %} {{ errors['email'] }} {% endif %}</div>    
                        </div>
                        <div class="blockI">
                            <label>Prénom</label><br>
                            <input type="text" name="prenom" {% if app.user.firstname %} value="{{ app.user.firstname }}" {% else %} placeholder="Non spécifié." {% endif %} {% if not edit_mode %}readonly{% endif %}><br>
                        </div>
                        <div class="blockI">
                            <label>Nom</label><br>
                            <input type="text" name="nom" {% if app.user.surname %} value="{{ app.user.surname }}" {% else %} placeholder="Non spécifié." {% endif %} {% if not edit_mode %}readonly{% endif %}><br>    
                        </div>
                    </div>
                    <div style="margin-left: auto;">
                        Abonnement (après la fin de celui en cours) :<br>
                        <div class="plans">
                            {% for abo in abonnements %}
                                {% if abo.getNiveau() == 1 %}
                                <input type="radio" id="option1" name="options" value={{ abo.nom }} {% if abo.nom == app.user.nextAbonnement.nom %}checked{% endif %} {% if not edit_mode %}disabled{% endif %}>
                                <label for="option1">
                                    <div class="title">{{ abo.nom }}</div>
                                    <div class="infos">
                                        <ul>
                                            <li>Prix : {{ abo.prix }} €/an</li>
                                            <li>Fonctionalités :
                                                <ul>
                                                    <li>Prêter du matériel</li>
                                                    <li>Offrir des services</li>
                                                    <li>Recevoir des services</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </label>
                                {% else %}
                                <input type="radio" id="option2" name="options" value={{ abo.nom }} {% if abo.nom == app.user.nextAbonnement.nom %}checked{% endif %} {% if not edit_mode %}disabled{% endif %}>
                                <label for="option2">
                                    <div class="title">{{ abo.nom }}</div>
                                    <div class="infos">
                                        <ul>
                                            <li>Prix : {{ abo.prix }} €/an</li>
                                            <li>Fonctionalités bonus :
                                                <ul>
                                                    <li>Emprunter du matériel</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </label>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <button type="submit" name="valider" {% if not edit_mode %}class="but validerBouton" {% else %} class="but"{% endif %}>Valider les modifications</button>
            </form>
        </div>
        <!-- Boîte de dialogue pour le mot de passe -->
        <dialog id='mdpDialog'>
            <h2 id='test'>Changement du mot de passe</h2>
            <form onsubmit='submitMotDePasseForm(event)'>
                <div>
                    <label for="motDePasseActuel">Mot de passe actuel</label>
                    <div class='blocMDP'>
                        <input type="password" id="motDePasseActuel" class='mdp' name="motDePasseActuel" required>
                        <span class="material-icons visibilite" onclick="toggleVisiblite('motDePasseActuel', this)">visibility</span>
                    </div>
                    <span class="errone cache" id="motDePasseActuelErreur">Le mot de passe ne correspond pas</span>
                </div>

                <div>
                    <label for="nouveauMotDePasse">Nouveau Mot de passe</label>
                    <span class="errone cache" id="nouveauMotDePasseErreur">Le mot de passe ne respecte pas les conditions</span>
                    <div class="blocMDP">
                        <input type="password" id="nouveauMotDePasse" class='mdp' name="nouveauMotDePasse" required>
                        <span class="material-icons visibilite" onclick="toggleVisiblite('nouveauMotDePasse', this)">visibility</span>
                    </div>
                    <span class='condMotDePasse'>Le mot de passe doit avoir au moins 6 caractères</span>
                </div>

                <div>
                    <label for="confirmNouveauMDP">Confirmer le nouveau mot de passe</label>
                    <div class="blocMDP">
                        <input type="password" id="confirmNouveauMDP" class='mdp' name="confirmNouveauMDP" required>
                        <span class="material-icons visibilite" onclick="toggleVisiblite('confirmNouveauMDP', this)">visibility</span>
                    </div>
                    <span class="errone cache" id="confirmNouveauMDPErreur" >Mots de passe différents</span>
                </div>

                <div class="boutonsDialog">
                    <button type="submit" class='but boutonDialog'>Valider</button>
                    <button type="button" class='but boutonDialog' onclick="closeDialog()">Annuler</button>
                </div>
                <span class='succes cache' id='messageSucces'>Changement réussi !</span>
            </form>
        </dialog>
    </div>

    <div id="tab2" class="tab">
        <h3>Mes Annonces</h3>
        <div class="tout">
            {% for annonce in annonces %}
                <div class="blocAnnonce">
                    <div>
                        <span class="prix">{{ annonce.getPrix() }}<span class="material-icons">attach_money</span></span>
                    <span class="username">{{ annonce.getPosteur().getUsername() }}</span>
                    </div>
                    <div class="type">{{ annonce.getType() }}</div>
                    <div class="categorie">{{ annonce.getCategorie().getNom() }}</div>
                    {% if annonce.getType() == "Materiel" %}<div class="duree">Durée du prêt : {{ annonce.getDuree() }}</div>{% endif %}
                    <h3>{{ annonce.getTitre() }}</h3>
                    <div class="description">{{ annonce.getDescription() }}</div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div id="tab3" class="tab">
        <p class="big">CIRCULEZ, IL N'Y A RIEN A VOIR.</p>
    </div>

    <div id="tab4" class="tab">
        <p class="big">CIRCULEZ, IL N'Y A RIEN A VOIR.</p>
    </div>
</div>

</body>
</html>

{% endblock %}
